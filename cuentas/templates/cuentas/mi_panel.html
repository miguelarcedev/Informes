{% extends "base.html" %}
{% load static %}
{% load filtros_a√±os %}
{% load filtros_meses %}

{% block contenido %}
<div class="container my-3 px-2">

  <style>
    /* Acorde√≥n */
    .accordion-button {
      background-color: #f8faff;
      color: #333;
      font-weight: 500;
      font-size: 0.9rem; /* m√°s peque√±o */
      cursor: pointer;
      transition: all 0.25s ease;
      border-radius: 0.5rem !important;
      padding: 0.4rem 0.75rem; /* compacto */
    }
    .accordion-button:hover {
      background-color: #edf2ff;
    }
    .accordion-button:not(.collapsed) {
      background-color: #dbe4ff;
      color: #212529;
      box-shadow: inset 0 -1px 0 rgba(0,0,0,.1);
    }
    .accordion-item {
      border-radius: 0.75rem;
      overflow: hidden;
      margin-bottom: 0.5rem;
      border: 1px solid #dee2e6;
      box-shadow: 0 2px 6px rgba(0,0,0,0.05);
    }
    .accordion-body {
      background-color: #fff;
      border-top: 1px solid #e9ecef;
      padding: 0.75rem; /* compacto */
      font-size: 0.9rem;
    }

    /* Tablas compactas */
    .table {
      font-size: 0.8rem; /* letras m√°s chicas */
    }
    .table th,
    .table td {
      padding: 0.35rem 0.5rem; /* reduce padding */
      vertical-align: middle;
    }
    thead {
      background-color: #f1f3f5;
    }
    th {
      font-weight: 600;
      font-size: 0.75rem; /* t√≠tulos m√°s chicos */
      text-transform: uppercase;
    }

    /* Botones */
    .btn {
      font-size: 0.75rem; /* m√°s peque√±os */
      padding: 0.25rem 0.5rem;
    }
    .btn-sm {
      padding: 0.2rem 0.4rem;
    }
    .btn-primary {
      background-color: #4c6ef5;
      border-color: #4c6ef5;
    }
    .btn-primary:hover {
      background-color: #3b5bdb;
      border-color: #3b5bdb;
    }
    .btn-warning {
      border-radius: 0.4rem;
    }

    /* Alertas */
    .alert {
      border-radius: 0.5rem;
      font-size: 0.85rem;
      padding: 0.5rem 0.75rem;
    }

    /* Datos usuario/publicador */
    .datos p {
      margin-bottom: 0.2rem;
      line-height: 1.2;
      font-size: 0.85rem;
    }
  </style>

  <!-- Mensajes -->
  {% if messages %}
    <div class="mb-2">
      {% for message in messages %}
        <div class="alert alert-{{ message.tags }} alert-dismissible fade show shadow-sm small" role="alert">
          {{ message }}
          <button type="button" class="btn-close btn-sm" data-bs-dismiss="alert"></button>
        </div>
      {% endfor %}
    </div>
  {% endif %}

  <!-- Acorde√≥n principal -->
  <div class="accordion" id="accordionDatos">

    <!-- Usuario -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingUsuario">
        <button class="accordion-button" type="button" 
                data-bs-toggle="collapse" data-bs-target="#collapseUsuario" 
                aria-expanded="true" aria-controls="collapseUsuario">
          üë§ Datos del Usuario
        </button>
      </h2>
      <div id="collapseUsuario" class="accordion-collapse collapse show" 
           aria-labelledby="headingUsuario" data-bs-parent="#accordionDatos">
        <div class="accordion-body datos">
          <p><strong>Usuario:</strong> {{ user.username }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Nombre:</strong> {{ user.get_full_name }}</p>
        </div>
      </div>
    </div>

    <!-- Publicador -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingPublicador">
        <button class="accordion-button collapsed" type="button" 
                data-bs-toggle="collapse" data-bs-target="#collapsePublicador" 
                aria-expanded="false" aria-controls="collapsePublicador">
          üìë Datos del Publicador
        </button>
      </h2>
      <div id="collapsePublicador" class="accordion-collapse collapse" 
           aria-labelledby="headingPublicador" data-bs-parent="#accordionDatos">
        <div class="accordion-body datos">
          {% if publicador %}
            <p><strong>ID:</strong> {{ publicador.id }}</p>
            <p><strong>Nombre:</strong> {{ publicador.nombre }} {{ publicador.apellido }}</p>
            <p><strong>Nacimiento:</strong> {{ publicador.nacimiento|default_if_none:""  }}</p>
            <p><strong>Bautismo:</strong> {{ publicador.bautismo|default_if_none:"" }}</p>
            <p><strong>Estado:</strong> {{ publicador.estado }}</p>
            <p><strong>Grupo:</strong> {{ publicador.grupo }}</p>
            <p><strong>Tel:</strong> {{ publicador.telefono }}</p>
            <p><strong>Contacto:</strong> {{ publicador.contacto|default_if_none:""  }}</p>
            <p><strong>Tel. contacto:</strong> {{ publicador.telefono_contacto }}</p>
          {% else %}
            <div class="alert alert-warning mt-2 shadow-sm small" role="alert">
              ‚ö†Ô∏è Tus registros no est√°n vinculados a un publicador. Contacta al Secretario.
            </div>
          {% endif %}
        </div>
      </div>
    </div>

    <!-- Informes -->
    <div class="accordion-item">
      <h2 class="accordion-header" id="headingInformes">
        <button class="accordion-button collapsed" type="button" 
                data-bs-toggle="collapse" data-bs-target="#collapseInformes" 
                aria-expanded="false" aria-controls="collapseInformes">
          üìä Informes
        </button>
      </h2>
      <div id="collapseInformes" class="accordion-collapse collapse" 
           aria-labelledby="headingInformes" data-bs-parent="#accordionDatos">
        <div class="accordion-body">

          {% if publicador %}
            <div class="d-flex justify-content-end mb-2">
               {% if publicador.estado == "Activo" %}
                <a href="{% url 'crear_informe' %}" class="btn btn-sm btn-primary shadow-sm">
                  ‚ûï Informe
                </a>
               {% endif %}
            </div>

            {% if a√±os_ordenados %}
            <div class="accordion" id="accordionAnios">
              {% for a√±o in a√±os_ordenados %}
              <div class="accordion-item">
                <h2 class="accordion-header" id="heading{{ a√±o }}">
                  <button class="accordion-button {% if not forloop.first %}collapsed{% endif %}" 
                          type="button" data-bs-toggle="collapse" 
                          data-bs-target="#collapse{{ a√±o }}"
                          aria-expanded="{% if forloop.first %}true{% else %}false{% endif %}"
                          aria-controls="collapse{{ a√±o }}">
                    üìÖ {{ a√±o }}
                  </button>
                </h2>
                <div id="collapse{{ a√±o }}" 
                     class="accordion-collapse collapse {% if forloop.first %}show{% endif %}" 
                     aria-labelledby="heading{{ a√±o }}" data-bs-parent="#accordionAnios">
                  <div class="accordion-body p-0">
                    <div class="table-responsive">
                      <table class="table table-striped table-hover table-bordered mb-0">
                        <thead>
                          <tr>
                            <th>Mes</th>
                            <th class="d-none d-sm-table-cell">Part.</th>
                            <th class="d-none d-sm-table-cell">Est.</th>
                            <th>Aux.</th>
                            <th>Hrs</th>
                            <th>Notas</th>
                            <th>Acc.</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for informe in informes_agrupados|get_item:a√±o %}
                          <tr>
                            <td>{{ informe.mes|mes_personalizado }}</td>
                            <td class="d-none d-sm-table-cell">{{ informe.participacion }}</td>
                            <td class="d-none d-sm-table-cell">{{ informe.estudios }}</td>
                            {% if informe.servicio == "Auxiliar" %}
                              <td> Si </td>
                            {% else %}
                              <td>  </td>
                            {% endif %}
                            <td>{{ informe.horas }}</td>
                            <td>{{ informe.notas|default_if_none:"" }}</td>
                            <td>
                              {% if publicador.estado == "Activo" %}
                                <a href="{% url 'editar_informe' informe.id %}" 
                                   class="btn btn-sm btn-warning shadow-sm">‚úèÔ∏è</a>
                              {% endif %}
                            </td>
                          </tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  </div>
                </div>
              </div>
              {% endfor %}
            </div>
            {% else %}
            <p class="text-muted fst-italic small">No hay informes disponibles.</p>
            {% endif %}

          {% else %}
            <div class="alert alert-warning mt-2 shadow-sm small" role="alert">
              üö´ No puedes ver informes porque tu usuario no est√° vinculado a un publicador.
            </div>
          {% endif %}

        </div>
      </div>
    </div>

  </div>
</div>
{% endblock %}
